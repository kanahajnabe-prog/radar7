<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø°ÙƒÙŠ | Smart Drive</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --primary-green: #22c55e;
            --danger-red: #ef4444;
            --warning-yellow: #f59e0b;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard {
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* ØªØµÙ…ÙŠÙ… Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø±Ø¹Ø© */
        .speedometer {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 8px solid var(--card-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            transition: all 0.3s ease;
            position: relative;
        }

        .speed-value {
            font-size: 80px;
            font-weight: bold;
            line-height: 1;
        }

        .unit {
            font-size: 20px;
            color: #94a3b8;
        }

        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .safe { border-color: var(--primary-green); color: var(--primary-green); }
        .warning { border-color: var(--warning-yellow); color: var(--warning-yellow); }
        .danger { 
            border-color: var(--danger-red); 
            color: var(--danger-red); 
            animation: pulse-red 0.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0px var(--danger-red); }
            50% { box-shadow: 0 0 30px var(--danger-red); background: #450a0a; }
            100% { box-shadow: 0 0 0px var(--danger-red); }
        }

        .status-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .radar-info {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .radar-limit {
            background: white;
            color: black;
            padding: 2px 10px;
            border-radius: 50%;
            font-weight: bold;
            border: 2px solid red;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <div id="main-circle" class="speedometer safe">
            <span id="current-speed" class="speed-value">0</span>
            <span class="unit">ÙƒÙ…/Ø³</span>
        </div>

        <div class="status-box">
            <div id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©...</div>
            <div id="radar-details" style="margin-top: 10px; display: none;">
                Ø¨Ø¹Ø¯: <span id="distance">--</span> Ù…ØªØ± | Ø§Ù„Ø­Ø¯: <span class="radar-limit" id="limit">--</span>
            </div>
        </div>
    </div>

    <script>
        let speedTraps = [];
        let lastSpeakTime = 0;

        // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        async function loadRadars(lat, lng) {
            const query = `[out:json];node["highway"="speed_camera"](around:10000,${lat},${lng});out body;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                speedTraps = data.elements.map(e => ({
                    lat: e.lat, lng: e.lon, 
                    limit: parseInt(e.tags.maxspeed) || 80
                }));
                document.getElementById('status-text').innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±ÙŠÙ‚ âœ…";
            } catch (e) { console.error("Error fetching radars"); }
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø±ÙƒØ©
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(async (pos) => {
                const { latitude, longitude, speed } = pos.coords;
                const currentKmh = Math.round(speed * 3.6) || 0;
                
                document.getElementById('current-speed').innerText = currentKmh;

                if (speedTraps.length === 0) await loadRadars(latitude, longitude);

                updateUI(latitude, longitude, currentKmh);
            }, null, { enableHighAccuracy: true });
        }

        function updateUI(lat, lng, speed) {
            let nearest = null;
            let minDist = Infinity;

            speedTraps.forEach(t => {
                const d = getDistance(lat, lng, t.lat, t.lng);
                if (d < minDist) { minDist = d; nearest = t; }
            });

            const circle = document.getElementById('main-circle');
            const statusText = document.getElementById('status-text');
            const details = document.getElementById('radar-details');

            if (minDist < 600) { // ØªÙ†Ø¨ÙŠÙ‡ Ø¶Ù…Ù† 600 Ù…ØªØ±
                details.style.display = "block";
                document.getElementById('distance').innerText = Math.round(minDist);
                document.getElementById('limit').innerText = nearest.limit;

                if (speed > nearest.limit) {
                    circle.className = "speedometer danger";
                    statusText.innerText = "ðŸš¨ Ø®ÙÙ Ø§Ù„Ø³Ø±Ø¹Ø© ÙÙˆØ±Ø§Ù‹!";
                    announce(`Ø§Ù†ØªØ¨Ù‡ØŒ Ø±Ø§Ø¯Ø§Ø±ØŒ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© ${nearest.limit}`);
                } else {
                    circle.className = "speedometer warning";
                    statusText.innerText = "âš ï¸ Ø±Ø§Ø¯Ø§Ø± Ù‚Ø±ÙŠØ¨";
                }
            } else {
                circle.className = "speedometer safe";
                statusText.innerText = "Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¢Ù…Ù† âœ…";
                details.style.display = "none";
            }
        }

        function announce(txt) {
            if (Date.now() - lastSpeakTime > 15000) {
                const msg = new SpeechSynthesisUtterance(txt);
                msg.lang = 'ar-SA';
                window.speechSynthesis.speak(msg);
                lastSpeakTime = Date.now();
            }
        }
    </script>
</body>
</html>
