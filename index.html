<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙƒØ§Ø´Ù Ø§Ù„Ø±Ø§Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background: #1a1a1a; color: white; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: #2d2d2d; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #status { font-size: 1.4rem; margin: 20px 0; padding: 15px; border-radius: 8px; transition: 0.3s; }
        .safe { background: #28a745; border: 2px solid #1e7e34; }
        .warning { background: #dc3545; border: 2px solid #bd2130; animation: pulse 1s infinite; }
        #details { font-size: 1.1rem; color: #ccc; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ÙƒØ§Ø´Ù Ø§Ù„Ø±Ø§Ø¯Ø§Ø±Ø§Øª</h1>
        <div id="status" class="safe">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</div>
        <div id="details">Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</div>
    </div>

    <script>
        let speedTraps = []; // Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const alertDistance = 500; // Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ù…ØªØ±)
        let lastAlertTime = 0;

        // 1. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±Ø§Øª Ù…Ù† Overpass API
        async function fetchRadars(lat, lng) {
            const radius = 10000; // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ø­ÙŠØ· 10 ÙƒÙŠÙ„Ùˆ
            const query = `[out:json];node["highway"="speed_camera"](around:${radius},${lat},${lng});out body;`;
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                speedTraps = data.elements.map(item => ({
                    lat: item.lat,
                    lng: item.lon,
                    limit: item.tags.maxspeed || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
                }));
                document.getElementById('details').innerHTML = `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${speedTraps.length} Ø±Ø§Ø¯Ø§Ø± ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ.`;
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
            }
        }

        // 2. Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // 3. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(async (position) => {
                const { latitude, longitude } = position.coords;

                // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø· Ø£Ùˆ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø±Ùƒ Ù…Ø³Ø§ÙØ© ÙƒØ¨ÙŠØ±Ø©
                if (speedTraps.length === 0) {
                    await fetchRadars(latitude, longitude);
                }

                checkProximity(latitude, longitude);
            }, (err) => {
                document.getElementById('status').innerHTML = "ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS";
            }, { enableHighAccuracy: true });
        }

        function checkProximity(userLat, userLng) {
            let nearestTrap = null;
            let minDistance = Infinity;

            speedTraps.forEach(trap => {
                const dist = getDistance(userLat, userLng, trap.lat, trap.lng);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestTrap = trap;
                }
            });

            const statusDiv = document.getElementById('status');
            const detailsDiv = document.getElementById('details');

            if (minDistance <= alertDistance) {
                statusDiv.innerHTML = "ğŸš¨ Ø±Ø§Ø¯Ø§Ø± Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹!";
                statusDiv.className = "warning";
                detailsDiv.innerHTML = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${Math.round(minDistance)} Ù…ØªØ± | Ø§Ù„Ø³Ø±Ø¹Ø©: ${nearestTrap.limit} ÙƒÙ…/Ø³`;
                
                // ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ø¸Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹
                if (Date.now() - lastAlertTime > 15000) {
                    speak(`Ø§Ù†ØªØ¨Ù‡ØŒ Ø±Ø§Ø¯Ø§Ø± Ø¨Ø¹Ø¯ ${Math.round(minDistance)} Ù…ØªØ±`);
                    lastAlertTime = Date.now();
                }
            } else {
                statusDiv.innerHTML = "Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¢Ù…Ù† âœ…";
                statusDiv.className = "safe";
                detailsDiv.innerHTML = `Ø£Ù‚Ø±Ø¨ Ø±Ø§Ø¯Ø§Ø± Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ ${speedTraps.length > 0 ? Math.round(minDistance/1000) + ' ÙƒÙ…' : '...'} `;
            }
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'ar-SA';
            window.speechSynthesis.speak(msg);
        }
    </script>
</body>
</html>
